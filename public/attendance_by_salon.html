<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tomar Asistencia por Salón</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white rounded-lg shadow p-6">
    <h1 class="text-2xl font-bold mb-4">Tomar asistencia — por Salón</h1>

    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Salón</label>
      <select id="salonSelect" class="w-full border rounded px-3 py-2">
        <option value="">Cargando salones...</option>
      </select>
    </div>

    <div id="teamsContainer" class="space-y-4 mt-6">
      <!-- Lista de equipos aparecerá aquí -->
    </div>

    <div class="flex justify-end space-x-3 mt-6">
      <button id="exportCsv" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">Exportar CSV</button>
      <a href="/" class="bg-gray-200 px-4 py-2 rounded hover:bg-gray-300">Volver</a>
    </div>
  </div>

      <script>
      // Fallback sample data (extraída del archivo proporcionado)
      const fallbackData = {
        "D-303": [
          "Prograballon",
          "LosinjertosdeTI",
          "NICOSAN",
          "Los3pelados",
          "VibeCoders",
          "FPJ",
          "Loscompiladores"
        ],
        "D-305": [
          "PushForce",
          "AnMaFra",
          "JSW",
          "ByteTron",
          "PythonCrew",
          "LosDepuradores"
        ]
      };
  
      async function fetchTeamsBySalon() {
        try {
          const res = await fetch('/api/teams');
          if (!res.ok) throw new Error('No API');
          const json = await res.json();
  
          // Si la API devuelve un array de equipos, lo agrupamos por campo 'salon' si existe
          if (Array.isArray(json)) {
            const grouped = {};
            json.forEach(t => {
              const salonKey = t.salon || 'Sin salón';
              if (!grouped[salonKey]) grouped[salonKey] = [];
              grouped[salonKey].push(t.name || t);
            });
            return grouped;
          }
  
          // Si la API ya devuelve un objeto agrupado (salon -> [names]) lo usamos tal cual
          if (json && typeof json === 'object') return json;
  
          return fallbackData;
        } catch (e) {
          console.warn('No se pudo obtener datos desde la API, usando datos de ejemplo.', e);
          return fallbackData;
        }
      }
  
      async function fetchMembersForTeam(teamName) {
        try {
          const res = await fetch('/api/teams/' + encodeURIComponent(teamName) + '/members');
          if (!res.ok) throw new Error('No API');
          const json = await res.json();
          // Esperamos array de miembros { student_id, full_name, email }
          return json;
        } catch (e) {
          console.warn('No se pudo obtener miembros para', teamName, e);
          return [];
        }
      }
  
      function renderSalonOptions(data) {
        const select = document.getElementById('salonSelect');
        select.innerHTML = '<option value="">-- Selecciona un salón --</option>';
        Object.keys(data).forEach(salon => {
          const opt = document.createElement('option');
          opt.value = salon;
          opt.textContent = `Salón ${salon}`;
          select.appendChild(opt);
        });
      }
  
      function createTeamRow(teamName) {
        const row = document.createElement('div');
        row.className = 'border-b pb-2 flex items-start justify-between space-x-4';
  
        const left = document.createElement('div');
        left.className = 'flex-1';
  
        const header = document.createElement('div');
        header.className = 'flex items-center space-x-3';
  
        const nameSpan = document.createElement('span');
        nameSpan.className = 'font-medium';
        nameSpan.textContent = teamName;
        header.appendChild(nameSpan);
  
        const viewBtn = document.createElement('button');
        viewBtn.className = 'ml-2 text-sm text-blue-600 hover:underline bg-transparent border-0';
        viewBtn.textContent = 'Ver miembros';
        header.appendChild(viewBtn);
  
        left.appendChild(header);
  
        const expanded = document.createElement('div');
        expanded.className = 'mt-2 w-full';
        left.appendChild(expanded);
  
        const right = document.createElement('div');
        right.className = 'flex items-center space-x-3';
  
        const teamCheckbox = document.createElement('input');
        teamCheckbox.type = 'checkbox';
        teamCheckbox.dataset.team = teamName;
        teamCheckbox.className = 'team-checkbox';
        right.appendChild(teamCheckbox);
  
        const label = document.createElement('span');
        label.className = 'text-sm text-gray-600';
        label.textContent = 'Presente (equipo)';
        right.appendChild(label);
  
        row.appendChild(left);
        row.appendChild(right);
  
        // toggle members on click
        let membersLoaded = false;
        viewBtn.addEventListener('click', async () => {
          if (!membersLoaded) {
            expanded.innerHTML = '<div class="text-sm text-gray-500">Cargando miembros...</div>';
            const members = await fetchMembersForTeam(teamName);
            expanded.innerHTML = '';
            if (!members || members.length === 0) {
              expanded.innerHTML = '<div class="text-sm text-gray-500">No se encontraron miembros.</div>';
            } else {
              const list = document.createElement('div');
              list.className = 'space-y-2';
              members.forEach(m => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between';
                const info = document.createElement('div');
                info.innerHTML = `<div class="font-medium">${m.fullName}</div><div class="text-sm text-gray-600">${m.studentId} — ${m.email || ''}</div>`;
                const rightItem = document.createElement('div');
                rightItem.className = 'flex items-center space-x-2';
                const cb = document.createElement('input');
                cb.type = 'checkbox';
                cb.dataset.studentId = m.studentId;
                cb.dataset.team = teamName;
                cb.className = 'member-checkbox';
                rightItem.appendChild(cb);
                const lab = document.createElement('span');
                lab.className = 'text-sm text-gray-600';
                lab.textContent = 'Presente';
                rightItem.appendChild(lab);
                item.appendChild(info);
                item.appendChild(rightItem);
                list.appendChild(item);
              });
              expanded.appendChild(list);
  
              // si se marca el equipo como presente, marcar todos los miembros
              teamCheckbox.addEventListener('change', () => {
                const mems = expanded.querySelectorAll('.member-checkbox');
                mems.forEach(mcb => mcb.checked = teamCheckbox.checked);
              });
            }
            membersLoaded = true;
          } else {
            // toggle visibility
            expanded.style.display = expanded.style.display === 'none' ? 'block' : 'none';
          }
        });
  
        return row;
      }
  
      function renderTeams(salon, teams) {
        const container = document.getElementById('teamsContainer');
        container.innerHTML = '';
        if (!salon) return;
  
        const card = document.createElement('div');
        card.className = 'bg-gray-50 p-4 rounded shadow';
        const title = document.createElement('h2');
        title.className = 'text-lg font-semibold mb-3';
        title.textContent = `Equipos en Salón ${salon}`;
        card.appendChild(title);
  
        const list = document.createElement('div');
        list.className = 'space-y-3';
  
        teams.forEach(team => {
          const teamName = team.name || team;
          const row = createTeamRow(teamName);
          list.appendChild(row);
        });
  
        card.appendChild(list);
  
        // Añadimos botones de acción debajo de la lista
        const actions = document.createElement('div');
        actions.className = 'mt-4 flex items-center justify-between';
  
        const bulkBtn = document.createElement('button');
        bulkBtn.className = 'bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700 text-sm';
        bulkBtn.textContent = 'Marcar todos presentes (miembros y equipos)';
        bulkBtn.addEventListener('click', ()=>{
          container.querySelectorAll('input[type=checkbox]').forEach(cb => cb.checked = true);
        });
  
        const saveBtn = document.createElement('button');
        saveBtn.className = 'bg-indigo-600 text-white px-3 py-1 rounded hover:bg-indigo-700 text-sm';
        saveBtn.textContent = 'Guardar Asistencia';
        saveBtn.addEventListener('click', ()=> saveAttendance(salon));
  
        actions.appendChild(bulkBtn);
        actions.appendChild(saveBtn);
  
        card.appendChild(actions);
        container.appendChild(card);
      }
  
      async function saveAttendance(salon) {
        if (!salon) return alert('Selecciona un salón primero');
        const container = document.getElementById('teamsContainer');
        const records = [];
  
        // Para cada equipo
        const teamCards = container.querySelectorAll('div.bg-gray-50 > div.space-y-3 > div');
        if (teamCards.length === 0) {
          // alternativa: buscar checkboxes a nivel general
          const cbs = container.querySelectorAll('input.team-checkbox');
          cbs.forEach(cb => {
            records.push({ team: cb.dataset.team, student_id: null, present: cb.checked ? 1 : 0 });
          });
        } else {
          container.querySelectorAll('.team-checkbox').forEach(cb => {
            const teamName = cb.dataset.team;
            // buscar miembros cargados para ese equipo
            const teamSection = cb.closest('div').querySelector('div');
            const memberCbs = cb.closest('div').querySelectorAll('.member-checkbox');
            if (memberCbs && memberCbs.length > 0) {
              memberCbs.forEach(mcb => {
                records.push({ team: teamName, student_id: mcb.dataset.studentId, present: mcb.checked ? 1 : 0 });
              });
            } else {
              records.push({ team: teamName, student_id: null, present: cb.checked ? 1 : 0 });
            }
          });
        }
  
        try {
          const res = await fetch('/api/attendance', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ type: 'salon', key: salon, records }),
          });
          if (!res.ok) throw new Error('Error al guardar');
          const json = await res.json();
          alert(`Asistencia guardada: ${json.saved || json.saved === 0 ? json.saved : 'ok'}`);
        } catch (e) {
          console.error('saveAttendance error', e);
          alert('No se pudo guardar la asistencia. Revisa la consola.');
        }
      }
  
      function exportCsv(salon) {
        if (!salon) return alert('Selecciona un salón primero');
        const rows = [['salon','team','student_id','present']];
        const container = document.getElementById('teamsContainer');
        // prefer member-level if available
        container.querySelectorAll('.team-checkbox').forEach(cb => {
          const teamName = cb.dataset.team;
          const memberCbs = cb.closest('div').querySelectorAll('.member-checkbox');
          if (memberCbs && memberCbs.length > 0) {
            memberCbs.forEach(mcb => rows.push([salon, teamName, mcb.dataset.studentId, mcb.checked ? '1' : '0']));
          } else {
            rows.push([salon, teamName, '', cb.checked ? '1' : '0']);
          }
        });
  
        const csv = rows.map(r => r.map(v => `"${String(v || '').replace(/"/g, '""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `asistencia_salon_${salon}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      }
  
      (async function init(){
        const data = await fetchTeamsBySalon();
        renderSalonOptions(data);
  
        document.getElementById('salonSelect').addEventListener('change', (e)=>{
          const salon = e.target.value;
          const teams = data[salon] || [];
          renderTeams(salon, teams);
        });
  
        document.getElementById('exportCsv').addEventListener('click', ()=>{
          const salon = document.getElementById('salonSelect').value;
          exportCsv(salon);
        });
      })();
    </script></body>
</html>
